---
title: Integrated Composer
description: Learn how to deploy a site with Integrated Composer
tags: [composer, workflow]
categories: [get-started]
contributors: [ari, edwardangert]
reviewed: "2020-11-18"
---

Integrated Composer lets you deploy your site on Pantheon with one-click updates for both upstream commits and Composer dependencies, while still receiving upstream updates.

Create a new site with Integrated Composer as part of Pantheon's Limited Availability release. New sites created through Pantheon's Limited Availability program are production-ready.

## Create a New Site With Integrated Composer

### Drupal 9 with Integrated Composer

Please note the Limited Availability program does not include a path to upgrade from previous Drupal versions to Drupal 9. Upgrade instructions for existing Drupal 8 Composer-enabled sites will be available when Integrated Composer moves into General Availability.

<Partial file="drupal-9-upstream-install.md" />

### WordPress with Integrated Composer

1. [Fork the Pantheon-maintained repository](/create-custom-upstream#create-and-host-the-repository-remotely) from [https://github.com/pantheon-upstreams/wordpress-project](https://github.com/pantheon-upstreams/wordpress-project).

1. [Add a new Custom Upstream](/create-custom-upstream#connect-repository-to-pantheon) on the Pantheon dashboard.

1. Create a new WordPress site from the Upstream.

   - Do not customize the upstream yet.

1. In the Dev environment, click **Visit Development Site** and follow the prompts to complete the CMS installation.

1. [Clone the site locally](/local-development#get-the-code) and run `composer install`.

## Upstream and Site Structure

The upstream has the following directory structure:

```none:title=core/
core/
├─ .gitignore
├─ composer.json
└─ pantheon.upstream.yml
├─ README.md
└─ upstream-configuration/
   └─ composer.json
```

- `.gitignore`: Prevents build artifacts generated by Composer from being committed to the upstream or site code repositories.
- `composer.json`: The two different `composer.json` files allow customization of individual sites without inherent merge conflicts and enable one-click updates.
  - Root-level: Site-level customizations.
  - `upstream-config/composer.json`: Composer automatically updates `composer.json` with customizations for the upstream. Avoid manually modifying this file.
- `pantheon.upstream.yml`: The `build_step: true` directive in `pantheon.upstream.yml` enables the build step.

When a site is created, Pantheon runs `composer install`, generates a `composer.lock` file and commits it back to the site’s code repository.

Build artifacts are stored in a Git tag like `pantheon_build_artifacts_$BRANCHNAME` (where `$BRANCHNAME` is the name of the environment or Multidev feature branch).

## How to Add Dependencies to Your Upstream

1. Start with the local clone of the Upstream repository you created above.

1. Change into the `upstream-config` directory:

  ```bash{promptUser: user}
  cd upstream-config
  ```

1. Run:

  ```bash{promptUser: user}
  composer require drupal/pkg-name --no-update
  ```

   `--no-update` tells Composer to disable automatic updates of the dependency. This makes Composer faster when adding dependencies to the Upstream as shown here. `--no-update` should not be included when adding dependencies to a site.

1. Set or increment the current configuration version:

   - If this is your first time setting the config version:

     Confirm the version:

     ```bash{outputLines:2}
     composer config version
     1.0.0
     ```

   - Increment the config version number when you update dependencies. If you don't increment the version number, Composer will ignore updated dependencies. Replace `1.0.1` in this example with another number:

     ```bash{promptUser: user}
     composer config version 1.0.1
     ```

1. Commit and push.

## Apply One-click Updates

Navigate to **Code** in the Dev tab of the site's Dashboard.

Click **Check Now**. If updates are available, click **Apply Updates**.

## Add a Dependency to an Individual Site

1. Clone the Git repository from the Pantheon site's dashboard.

1. Run `composer install`:

  ```bash{promptUser: user}
  composer install
  ```

1. Add a new dependency locally:

  ```bash{promptUser: user}
  composer require drupal/pkg-name
  ```

1. Commit `composer.json` and `composer.lock` and push.

   - Pantheon will run Composer, generate build artifacts, and deploy it to your Dev or Multidev environment.

1. Remove dependencies:

  ```bash{promptUser: user}
  composer remove drupal/pkg-name
  ```

## Pantheon's Scope of Support for Composer

<Partial file="composer-support-scope.md" />

## Troubleshooting / FAQ

### What Composer commands does Pantheon run?

All Composer commands are available through the **Commit Log** in the Site Dashboard's development environment.

### Can I view live logs?

Composer build logs are only available after the task or action completes (or fails).
### How do I view Composer's changes?

Use `git diff` to view changes, excluding composer.lock

```bash{promptUser: user}
git diff d94d1a1179 -- . ':(exclude)composer.lock'
```

Try [composer-lock-diff](https://github.com/davidrjonas/composer-lock-diff) to see what packages have changed after `composer update`.

### Can I use a Composer GUI?

Pantheon does not offer support for Composer GUIs or any conflicts that might be cause by one.

### Why are contrib modules placed in /modules/composer instead of /modules/contrib?

Integrated Composer needs to consider the use case where a site might already have non-Composer-managed modules in the standard `/modules/contrib` directory. To support this, we create the `/modules/composer` directory for modules added by Integrated Composer.

If your site does not fall into this category, it is safe to rename the `composer` directory back to the standard `contrib`.

### What features are planned for Integrated Composer on Pantheon?

Pantheon's devs are working hard to make the Integrated Composer experience on Pantheon better.

Features that are still in development:

 - Integrated Composer and [Build Tools](/guides/build-tools)
 - Upgrade an existing site to use Integrated Composer

### When Applying Upstream Updates, Updates Cannot Be Applied

When you click "Apply Updates", the process completes with an error: "Something went wrong when applying updates. View log"

Clicking on "View log" gives you this message:

```bash
We were not able to perform the merge safely. See the Applying Upstream Updates doc (https://pantheon.io/docs/core-updates) for further debugging tips. Conflicts: [
  "CONFLICT (content): Merge conflict in composer.json"
]
```

The upstream updates and your Composer changes to the site are in conflict that cannot be automatically merged by Git. To resolve this, you need to merge the changes manually. Checking the "Auto-resolve updates" will cause your changes to the site's composer.json file to be lost, so that is not a recommended option.

1. Create a local Git clone of the Pantheon site repository.
1. Run this command to merge in the upstream changes: git pull https://github.com/pantheon-upstreams/drupal-project master
1. You will get a message that there are conflicts in composer.json that cannot be merged automatically:
   ```bash{outputLines:4}
   Auto-merging composer.json
   CONFLICT (content): Merge conflict in composer.json
   
   Automatic merge failed; fix conflicts and then commit the result.
   ```
1. [Resolve the conflict](/git-resolve-merge-conflicts#resolve-content-conflicts) and follow the instructions to commit the merged changes.
1. To verify that the merge completed, run "compoer install" on your local copy to verify that the composer.json parses correctly and the correct libraries are installed/updated. If the command fails, the merge was not made correctly and the error may point to how the composer.json needs to change.
1. Push the changes to Pantheon. Integrated Composer will run again with the updated composer.json.

### When Applying Upstream Updates, "Auto-Resolve Updates" Was Selected And Changes Were Lost

When "Auto-Resolve Updates" is selected and the "composer.json" contents are changed in the upstream, all changes the site's developers made to composer.json will be removed if Git cannot automatically merge the changes.

To resolve, there are a couple potential solutions.:

1. Remove the upstream updates by [undoing the commits](/undo-commits#revert-a-prior-commit-on-pantheon-that-has-been-deployed) or [restoring from a backup](/restore-environment-backup) made before the updates were merged. Then do the merge manually as described in the previous section.
1. If you have a copy of the composer.json contents from before the updates were applied, then add the changes you made before back to the updated composer.json file.
